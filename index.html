<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Tunnel Cost Calculator</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: #f4f2f9;
    }

    .navigation {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 360px;
      height: 70px;
      background: #7b4dd6;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      padding: 0 20px;
    }

    .navigation ul {
      list-style: none;
      display: flex;
      justify-content: space-between;
      width: 100%;
      position: relative;
      padding: 0;
      margin: 0;
    }

    .navigation ul li {
      width: 25%;
      height: 70px;
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .navigation ul li a {
      text-decoration: none;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      width: 100%;
      height: 100%;
    }

    .navigation ul li .icon {
      line-height: 24px;
      text-align: center;
      color: #d6c9f7;
      transition: 0.3s ease;
    }

    .navigation ul li .icon ion-icon {
      font-size: 2.2rem;
    }

    .navigation ul li .text {
      font-size: 0.6rem;
      color: #d6c9f7;
      margin-top: -4px;
    }

    .navigation ul li.active .icon,
    .navigation ul li.active .text {
      color: #fff;
    }

    .indicator {
      position: absolute;
      bottom: 4px;
      height: 3px;
      width: 25%;
      background: #fff;
      border-radius: 2px;
      transition: left 0.3s ease;
      left: 0;
    }

    .bottom-panel {
      position: fixed;
      bottom: 0;
      left: 8px;
      right: 8px;
      width: auto;
      height: 75vh;
      background: #fff;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      transition: transform 0.3s ease;
      transform: translateY(100%);
      overflow-y: auto;
      padding: 25px 10px 20px;
    }

    .bottom-panel.open {
    transform: translateY(0);
    padding-bottom: 100px; /* üëà add this line */
    }


    .panel-header {
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
    }

    #userModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #userModal .box {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }
    .location-select {
    text-align: center; /* üëà this centers the selected text */
    padding: 12px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 100%;
    max-width: 100%;
    background: #fff;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    appearance: none;
    background-image: url('data:image/svg+xml;utf8,<svg fill=\'%237b4dd6\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
    background-repeat: no-repeat;
    background-position-x: 98%;
    background-position-y: center;
    background-size: 20px;
    }


    .session-card {
    background: #fff;
    border: 1px solid #ddd;
    border-left: 5px solid #7b4dd6;
    border-radius: 8px;
    padding: 12px 5px; /* üëà reduced top/bottom padding */
    margin-bottom: 10px; /* üëà smaller gap between cards */
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .session-card:hover {
    transform: translateY(-3px);
    }

    .session-card h4 {
    margin: 0; /* üëà remove all default margin */
    font-size: 16px;
    color: #333;
    line-height: 1.2;
    }


    .session-card p {
    margin: 4px 0;
    font-size: 14px;
    color: #555;
    }

    .session-card button {
    margin-top: 10px;
    padding: 10px 16px;  /* Slightly bigger but not huge */
    font-size: 15px;
    background: #7b4dd6;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: auto;         /* Let it size naturally */
    min-width: 100px;     /* Optional: keeps it from being too small */
    }


    .participant-row {
    display: flex;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 6px;
    margin-bottom: 10px;
    align-items: center;
    font-size: 14px;
    }

    .participant-row > .name {
    flex: 0 0 30%;
    font-weight: 600;
    text-align: left;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    }

    .participant-row > .time {
    flex: 1 1 50%;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    }

    .participant-row > .minutes {
    flex: 0 0 20%;
    text-align: right;
    white-space: nowrap;
    }

    #calendarStickyHeader {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    }

    .session-this-month {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
    font-size: 14px;
    }

    .session-this-month .location {
    flex: 1;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    }

    .session-this-month .time {
    flex: 1.2;
    text-align: center;
    white-space: nowrap;
    }

    .session-this-month .cost {
    flex: 0.8;
    text-align: right;
    font-weight: bold;
    white-space: nowrap;
    }

    #calendarHeader,
    #calendar {
    position: sticky;
    top: 0;
    background: white;
    z-index: 2;
    padding-top: 8px;
    padding-bottom: 8px;
    }

    #calendarStickyHeader {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
    }

    .session-info-card {
    background: #f6f5ff;
    border-left: 4px solid #7b4dd6;
    border-radius: 10px;
    padding: 12px 14px;
    margin-bottom: 12px;
    font-family: 'Poppins', sans-serif;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    .session-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .session-details {
    display: flex;
    flex-direction: column;
    }

    .session-title {
    font-weight: 600;
    font-size: 15px;
    color: #4a2e91;
    }

    .session-time {
    font-size: 13px;
    color: #777;
    margin-top: 2px;
    }

    .session-cost {
    font-weight: 600;
    font-size: 15px;
    color: #28a745;
    }

    .session-date {
    font-size: 12px;
    color: #aaa;
    margin-top: 2px;
    }


  </style>
</head>
<body>
  <div id="userModal">
    <div class="box">
      <h2>Welcome!</h2>
      <label for="modalName">Name:</label>
      <input type="text" id="modalName" style="width: 100%; padding: 8px; margin-bottom: 15px;" />
      <label>Gender:</label><br/>
      <label><input type="radio" name="modalGender" value="Male" /> Male</label><br/>
      <label><input type="radio" name="modalGender" value="Female" /> Female</label><br/><br/>
      <button onclick="submitUserInfo()">Continue</button>
    </div>
  </div>
  <div id="sessionInfoBlock" style="display:none; padding:20px; margin:20px; background:#fff; border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); max-width: 600px; margin-inline: auto;">
    <h2 style="text-align:center; color:#7b4dd6;">üéµ Session Info</h2>
    <p><strong>Location:</strong> <span id="infoLocation"></span></p>
    <p><strong>Session #:</strong> <span id="infoSessionId"></span></p>
    <p><strong>Session Start Time:</strong> <span id="infoStartTime"></span></p>
    <p><strong>Your Join Time:</strong> <span id="infoJoinTime"></span></p>
    <p><strong>Participants Joined:</strong> <span id="infoParticipants"></span></p>
    <div style="margin-top:20px; display:flex; justify-content:space-between;">
      <button onclick="leaveSession()" style="padding:10px 20px; background:#ccc; border:none; border-radius:6px;">Leave Session</button>
      <button id="endSessionBtn" onclick="endSession()" style="padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:6px; display:none;">End Session</button>
    </div>
  </div>
  
  <div class="container" style="padding: 20px; max-width: 600px; margin: auto;">
    <h2 style="color: #4a2e91; margin-bottom: 15px; text-align: center;">üéµ Start or Join a Session</h2>
  
    <div style="margin-bottom: 20px;">
      <label for="locationDropdown" style="display: block; font-weight: 600; margin-bottom: 6px;">Choose Location</label>
      <select id="locationDropdown" class="location-select" onchange="loadActiveSessions()" style="
        width: 100%;
        max-width: 100%;
        padding: 12px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        background-color: #fff;
        appearance: none;
        background-image: url('data:image/svg+xml;utf8,<svg fill=\'%237b4dd6\' height=\'24\' viewBox=\'0 0 24 24\' width=\'24\' xmlns=\'http://www.w3.org/2000/svg\'><path d=\'M7 10l5 5 5-5z\'/></svg>');
        background-repeat: no-repeat;
        background-position-x: 98%;
        background-position-y: center;
        background-size: 20px;
        "></select>

    </div>
  
    <div style="margin-bottom: 30px;">
      <h3 style="color: #7b4dd6; font-size: 18px; margin-bottom: 12px;">Active Sessions</h3>
      <div id="activeSessionsList">Loading...</div>
    </div>
  
    <div style="text-align: center;">
      <button id="startSessionBtn" onclick="startNewSession()" style="
        background: linear-gradient(to right, #6a4cc0, #8f5fff);
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: background 0.3s ease;
      ">
        <i class="fas fa-play-circle" style="margin-right: 8px;"></i> Start New Session
      </button>
    </div>
  </div>
  

  <div id="bottomPanel" class="bottom-panel">
    <div class="panel-header" id="panelHeader">Panel</div>
    <div id="panelContent">Content goes here...</div>
  </div>

  <div class="navigation">
    <ul>
      <li class="list active" onclick="togglePanel('participants')">
        <a href="javascript:void(0);">
          <span class="icon"><ion-icon name="people-outline"></ion-icon></span>
          <span class="text">Participants</span>
        </a>
      </li>
      <li class="list" onclick="togglePanel('calculator')">
        <a href="javascript:void(0);">
          <span class="icon"><ion-icon name="calculator-outline"></ion-icon></span>
          <span class="text">Calculator</span>
        </a>
      </li>
      <li class="list" onclick="togglePanel('history')">
        <a href="javascript:void(0);">
          <span class="icon"><ion-icon name="calendar-outline"></ion-icon></span>
          <span class="text">History</span>
        </a>
      </li>
      <li class="list" onclick="togglePanel('profile')">
        <a href="javascript:void(0);">
          <span class="icon"><ion-icon name="person-outline"></ion-icon></span>
          <span class="text">Profile</span>
        </a>
      </li>
      <div class="indicator" id="indicator"></div>
    </ul>
  </div>

  <script>
    const apiBase = 'https://admin-dashboard-e2ja.onrender.com';
    let sessionStartTime = null;
    let currentUser = { device_id: null, name: null, gender: null, participant_id: null };

    function formatTime(date) {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const suffix = hours >= 12 ? 'PM' : 'AM';
    const formatted = `${(hours % 12 || 12)}:${String(minutes).padStart(2, '0')} ${suffix}`;
    return formatted;
    }

    async function initializeDeviceUser() {
      const deviceId = localStorage.getItem('device_id');
      if (deviceId) {
        try {
          const res = await fetch(`${apiBase}/api/device-check`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: deviceId })
          });
          if (res.ok) {
            const data = await res.json();
            currentUser = { device_id: deviceId, name: data.name, gender: data.gender, participant_id: data.participant_id };
            return;
          }
        } catch (err) {
          console.error('Device check failed:', err);
        }
      }
      document.getElementById('userModal').style.display = 'flex';
    }


    async function submitUserInfo() {
      const name = document.getElementById('modalName').value.trim();
      const gender = document.querySelector('input[name="modalGender"]:checked')?.value;
      if (!name || !gender) return alert('Please enter name and select gender.');

      const tempId = `temp_${Date.now()}`;
      try {
        const res = await fetch(`${apiBase}/api/device-check`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, gender, device_id: tempId })
        });
        const data = await res.json();
        const finalId = `device_${data.participant_id}`;
        await fetch(`${apiBase}/api/update-device-id`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ participant_id: data.participant_id, device_id: finalId })
        });

        localStorage.setItem('device_id', finalId);
        currentUser = { device_id: finalId, name, gender, participant_id: data.participant_id };
        document.getElementById('userModal').style.display = 'none';
      } catch (err) {
        alert('Registration failed.');
        console.error(err);
      }
    }

    window.addEventListener('load', async () => {
      await initializeDeviceUser();
      await loadLocations();
      await loadActiveSessions();
      await checkAndResumeSessionFromDB();
    });

    async function loadLocations() {
    const res = await fetch(`${apiBase}/api/locations`);
    const data = await res.json();
    console.log('Fetched locations:', data); // <--- ADD THIS
    const dropdown = document.getElementById('locationDropdown');
    dropdown.innerHTML = '';
    data.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.location_id;
        option.textContent = loc.name;
        dropdown.appendChild(option);
    });
    }


    async function loadActiveSessions() {
        const locationId = document.getElementById('locationDropdown').value;
        const res = await fetch(`${apiBase}/api/sessions/active?location_id=${locationId}`);
        const sessions = await res.json();
      const activeContainer = document.getElementById('activeSessionsList');
      activeContainer.innerHTML = '';
      sessions.forEach(session => {
        const div = document.createElement('div');
        div.className = 'session-card';
        div.innerHTML = `
          <h4>Session #${session.session_id}</h4>
          <p><strong>Location:</strong> ${session.location_name}</p>
          <p><strong>Start Time:</strong> ${new Date(session.start_time).toLocaleString()}</p>
          <p><strong>Participants:</strong> ${session.participant_count}</p>
          <button onclick="joinSession(${session.session_id})">Join</button>
        `;
        activeContainer.appendChild(div);
      });
    }


    async function startNewSession() {
    const locationId = document.getElementById('locationDropdown').value;
    if (!locationId) return alert("Please select a location.");

    const startTime = new Date().toISOString();

    const res = await fetch(`${apiBase}/api/sessions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
        start_time: startTime,
        participant_id: currentUser.participant_id,
        location_id: locationId
        })
    });

    const data = await res.json();

    if (res.ok && data.session_id) {
        const sessionId = data.session_id;

        const joinTime = new Date().toISOString();
        await fetch(`${apiBase}/api/participant-sessions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            participant_id: currentUser.participant_id,
            session_id: sessionId,
            join_time: joinTime,
            leave_time: null
        })
        });

        alert(`Session started! Session ID: ${sessionId}`);
        await loadActiveSessions();

        // Fetch participant count after join
        const countRes = await fetch(`${apiBase}/api/sessions/active?location_id=${locationId}`);
        const sessionList = await countRes.json();
        const match = sessionList.find(s => s.session_id == sessionId);
        const participant_count = match?.participant_count || 1;

        showSessionInfo({
        session_id: sessionId,
        start_time: startTime,
        location: document.querySelector(`#locationDropdown option[value="${locationId}"]`)?.textContent,
        participant_count,
        user_join_time: joinTime,
        started_by_current_user: true
        });

    } else {
        alert("Failed to start session.");
    }
    }




    function joinSession(sessionId) {
      alert(`Joining session ID: ${sessionId} (implement logic here)`);
    }

  </script>
  <script>
    const panel = document.getElementById('bottomPanel');
    const header = document.getElementById('panelHeader');
    const content = document.getElementById('panelContent');
    const indicator = document.getElementById('indicator');
    const menuItems = document.querySelectorAll('.navigation .list');
    let currentPanel = null;
    let isPanelAnimating = false;

    function togglePanel(type) {
      if (isPanelAnimating) return;
      const index = type === 'participants' ? 0 :
                    type === 'calculator' ? 1 :
                    type === 'history' ? 2 :
                    type === 'profile' ? 3 : 0;

      indicator.style.left = `${index * 25}%`;
      menuItems.forEach(item => item.classList.remove('active'));
      menuItems[index].classList.add('active');

      if (currentPanel === type) {
        closePanel();
        return;
      }

      if (panel.classList.contains('open')) {
        isPanelAnimating = true;
        panel.classList.remove('open');
        setTimeout(() => {
          showPanel(type);
          panel.classList.add('open');
          isPanelAnimating = false;
        }, 300);
      } else {
        showPanel(type);
        panel.classList.add('open');
      }
    }

    function closePanel() {
      panel.classList.remove('open');
      currentPanel = null;
    }

    function showSessionInfo(session) {
        document.querySelector('.container').style.display = 'none';
        const block = document.getElementById('sessionInfoBlock');
        document.getElementById('infoLocation').textContent = session.location || 'N/A';
        document.getElementById('infoSessionId').textContent = session.session_id;
        document.getElementById('infoStartTime').textContent = new Date(session.start_time).toLocaleString();
        document.getElementById('infoJoinTime').textContent = new Date(session.user_join_time).toLocaleString();
        document.getElementById('infoParticipants').textContent = session.participant_count;

        if (session.started_by_current_user) {
            document.getElementById('endSessionBtn').style.display = 'inline-block';
        } else {
            document.getElementById('endSessionBtn').style.display = 'none';
        }

        block.style.display = 'block';
        }

    function showPanel(type) {
      currentPanel = type;
      if (type === 'participants') {
        header.textContent = 'Active Participants';

        const sessionId = document.getElementById('infoSessionId')?.textContent;
        if (!sessionId) {
            content.innerHTML = '<p style="text-align:center; margin-top:20px;">No active session.</p>';
            return;
        }

        fetch(`${apiBase}/api/sessions/${sessionId}/participants`)
            .then(res => res.json())
            .then(users => {
            if (users.length === 0) {
                content.innerHTML = '<p style="text-align:center; margin-top:20px;">No participants currently in session.</p>';
                return;
            }

            content.innerHTML = users.map(user => {
                const joinTime = new Date(user.join_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                return `
                <div style="
                    background: #f9f9ff;
                    border-left: 4px solid ${user.name === currentUser.name ? '#28a745' : '#7b4dd6'};
                    border-radius: 6px;
                    padding: 10px 15px;
                    margin-bottom: 10px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
                ">
                    <div style="font-weight:600; font-size: 15px;">
                    ${user.name} ${user.name === currentUser.name ? '<span style="color:green;">(You)</span>' : ''}
                    </div>
                    <div style="font-size: 13px; color: #555; display: flex; justify-content: space-between;">
                    <span>Gender: ${user.gender || 'N/A'}</span>
                    <span>Joined: ${joinTime}</span>
                    </div>
                </div>
                `;
            }).join('');
            })
            .catch(err => {
            console.error(err);
            content.innerHTML = '<p style="text-align:center; color:red;">Error loading participants.</p>';
            });
        }


        else if (type === 'calculator') {
        header.textContent = 'Cost Calculator';
        // Disable confirm button if not host
        const isHost = document.getElementById('endSessionBtn')?.style.display === 'inline-block';
        const confirmBtn = document.getElementById('confirmBtn');
        if (confirmBtn) {
        confirmBtn.disabled = !isHost;
        confirmBtn.style.opacity = isHost ? '1' : '0.5';
        confirmBtn.title = isHost ? 'Confirm and save cost data' : 'Only the session host can confirm costs';
        }

        content.innerHTML = `
        <div id="sessionDetails" style="margin-bottom: 20px; font-size: 15px;"></div>

        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
            <label for="calcPaid" style="font-weight: 600;">Total Paid ($):</label>
            <input type="number" id="calcPaid" step="0.01" placeholder="0.00"
            style="flex: 1; min-width: 120px; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px;" />
            <button onclick="confirmCostData()" style="padding: 10px 16px; background: #28a745; color: white; font-size: 14px; border: none; border-radius: 6px;">Confirm</button>
        </div>

        <div id="participantCostList" style="margin-bottom: 20px;"></div>

        <button onclick="calculateFinalCosts()" style="width: 100%; padding: 12px; background: #7b4dd6; color: white; font-size: 16px; border: none; border-radius: 8px; font-weight: 600;">
            üßÆ Calculate Cost Breakdown
        </button>

        <div id="calcResult" style="margin-top: 20px; font-size: 15px; line-height: 1.5;"></div>
        `;


        loadSessionAndParticipantsForCalc();  // Load session + participant data
        }

        else if (type === 'history') {
        header.style.display = 'none';
        header.textContent = 'History';
        content.innerHTML = `
        <div id="calendarStickyHeader">
            <div style="text-align:center; margin-bottom:10px;">
            <button onclick="changeMonth(-1)">‚Üê</button>
            <span id="calendarMonthLabel" style="margin: 0 10px; font-weight: bold;"></span>
            <button onclick="changeMonth(1)">‚Üí</button>
            </div>
            <div id="calendarHeader" style="display:grid; grid-template-columns:repeat(7,1fr); font-weight:bold; text-align:center; margin-bottom:5px;">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar" style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; text-align:center;"></div>
        </div>

        <div id="sessionListThisMonth" style="margin-top: 10px;"></div>
        <div id="dayDetails" style="margin-top:15px; text-align:center;"></div>
        `;

        generateCalendar();

      } else if (type === 'profile') {
        header.textContent = '';
        fetch(`${apiBase}/api/participant-sessions/${currentUser.participant_id}`)
          .then(res => res.json())
          .then(sessions => {
            const totalSpent = sessions.reduce((sum, s) => sum + (parseFloat(s.adjusted_cost) || 0), 0);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const thisMonthSpent = sessions.filter(s => s.join_time?.startsWith(currentMonth))
                                           .reduce((sum, s) => sum + (parseFloat(s.adjusted_cost) || 0), 0);
            const sessionCount = sessions.length;
            content.innerHTML = `
            <div style="background: radial-gradient(circle at center, #7b4dd6 0%, #453174 100%); padding: 30px 20px 20px; border-radius: 20px; text-align: center; color: white; position: relative;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 14px; padding: 0 10px; margin-bottom: 10px;">
                <div><i class="fas fa-id-badge"></i> ID#${currentUser.participant_id}</div>
                <div><i class="fas fa-venus-mars"></i> ${currentUser.gender}</div>
                </div>

                <img src="https://johnwusf.com/wechat_doghead.png" alt="Profile Picture" 
                style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; object-fit: cover; margin-bottom: 10px;" />
                
                <h2 style="margin: 8px 0 2px;">${currentUser.name}</h2>
            </div>

            <div style="padding: 20px; background: #fff; border-radius: 0 0 20px 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #eee;">
                <div><i class="fas fa-dollar-sign" style="margin-right: 8px; color: #7b4dd6;"></i>Total Spent</div>
                <div>$${totalSpent.toFixed(2)} <i class="fas fa-chevron-right" style="font-size: 12px; color: #ccc;"></i></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 10px; border-bottom: 1px solid #eee;">
                <div><i class="fas fa-calendar-alt" style="margin-right: 8px; color: #7b4dd6;"></i>This Month</div>
                <div>$${thisMonthSpent.toFixed(2)} <i class="fas fa-chevron-right" style="font-size: 12px; color: #ccc;"></i></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 10px;">
                <div><i class="fas fa-music" style="margin-right: 8px; color: #7b4dd6;"></i>Sessions Attended</div>
                <div>${sessionCount} <i class="fas fa-chevron-right" style="font-size: 12px; color: #ccc;"></i></div>
                </div>
            </div>
            `;




          })
          .catch(err => {
            content.innerHTML = '<p>Error loading profile data.</p>';
            console.error(err);
          });
      }
    }
    let calendarDate = new Date();

function changeMonth(offset) {
  calendarDate.setMonth(calendarDate.getMonth() + offset);
  generateCalendar();
}

async function generateCalendar() {
  const year = calendarDate.getFullYear();
  const month = calendarDate.getMonth(); // 0-based

  // Update label only (don't overwrite full structure)
  const label = document.getElementById('calendarMonthLabel');
  const cal = document.getElementById('calendar');
  const sessionListContainer = document.getElementById('sessionListThisMonth');

  label.textContent = calendarDate.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'long',
  });

  cal.innerHTML = ''; // Clear calendar
  sessionListContainer.innerHTML = ''; // Clear session list

  // Fetch all sessions
  const res = await fetch(`${apiBase}/api/participant-sessions/${currentUser.participant_id}`);
  const data = await res.json();


  // Filter to current month
  const sessionsThisMonth = data.filter((s) => {
    const date = new Date(s.join_time);
    return date.getFullYear() === year && date.getMonth() === month;
  });

  // Display session list for the month
  if (sessionsThisMonth.length) {
    sessionListContainer.innerHTML = `
      <h4 style="margin: 15px 0 10px; font-size: 16px;">Sessions This Month (${sessionsThisMonth.length})</h4>
      <div style="display: flex; flex-direction: column; gap: 10px;">
        ${sessionsThisMonth
          .map((s) => {
            const start = new Date(s.join_time);
            const end = s.leave_time ? new Date(s.leave_time) : null;
            return `
            <div class="session-info-card">
                <div class="session-main">
                <div class="session-details">
                    <div class="session-title">${s.location_name || 'Unknown'}</div>
                    <div class="session-time">
                    ${start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äì 
                    ${end ? end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Now'}
                    </div>
                </div>
                <div class="session-meta">
                    <div class="session-date">
                    ${start.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' })}
                    </div>
                    <div class="session-cost">
                    $${parseFloat(s.adjusted_cost || 0).toFixed(2)}
                    </div>
                </div>
                </div>
            </div>
            `;



          })
          
          .join('')}
      </div>
    `;

  } else {
    sessionListContainer.innerHTML = `<p style="color:#888; font-size:14px; margin-top:10px;">No sessions this month.</p>`;
  }

  // Build calendar
  const firstDay = new Date(year, month, 1);
  const lastDate = new Date(year, month + 1, 0).getDate();
  const startDay = firstDay.getDay();

  const dayMap = {};
  data.forEach((s) => {
    const date = new Date(s.join_time);
    const key = date.toISOString().split('T')[0];
    if (!dayMap[key]) dayMap[key] = [];
    dayMap[key].push({
      cost: parseFloat(s.adjusted_cost || 0),
      start: new Date(s.join_time),
      end: new Date(s.leave_time),
    });
  });

  for (let i = 0; i < startDay; i++) {
    cal.appendChild(document.createElement('div')); // empty cell
  }

  for (let d = 1; d <= lastDate; d++) {
    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
    const cell = document.createElement('div');
    cell.textContent = d;
    cell.style.padding = '8px';
    cell.style.borderRadius = '6px';
    cell.style.cursor = 'pointer';

    if (dayMap[dateKey]) {
      const sessions = dayMap[dateKey];
      const total = sessions.reduce((sum, s) => sum + s.cost, 0);
      cell.style.background = '#7b4dd6';
      cell.style.color = 'white';
      cell.style.fontWeight = 'bold';
      cell.title = `Total: $${total.toFixed(2)}\nTimes:\n${sessions
        .map(
          (s) =>
            `${s.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äì ${s.end.toLocaleTimeString([], {
              hour: '2-digit',
              minute: '2-digit',
            })}`
        )
        .join('\n')}`;
    }

    cal.appendChild(cell);
  }
}



    let touchStartY = 0;
    panel.addEventListener('touchstart', e => touchStartY = e.touches[0].clientY);
    panel.addEventListener('touchmove', e => {
      if (e.touches[0].clientY - touchStartY > 50) {
        closePanel();
        menuItems.forEach(item => item.classList.remove('active'));
      }
    
    async function loadActiveSessions() {
    const res = await fetch(`${apiBase}/api/sessions/active`);
    const sessions = await res.json();

    const container = document.querySelector('.container');
    container.innerHTML = `
        <h2>Active Sessions</h2>
        ${sessions.map(session => `
        <div class="session-card">
            <p><strong>Session #${session.session_id}</strong></p>
            <p><strong>Location:</strong> ${session.location_name || 'N/A'}<br>
            <p><strong>Start Time:</strong> ${new Date(session.start_time).toLocaleString()}</p>
            <p><strong>Participants:</strong> ${session.participant_count}</p>
            <button onclick="joinSession(${session.session_id})">Join</button>
        </div>
        `).join('')}
    `;
    }

    });
    async function checkAndResumeSessionFromDB() {
    const res = await fetch(`${apiBase}/api/participant-sessions/${currentUser.participant_id}`);
    const sessions = await res.json();

    const activeSession = sessions.find(s => !s.leave_time);
    if (!activeSession) return;

    const sessionId = activeSession.session_id;

    const sessionRes = await fetch(`${apiBase}/api/sessions`);
    const allSessions = await sessionRes.json();
    const fullSession = allSessions.find(s => s.session_id == sessionId);
    if (!fullSession) return;

    const locRes = await fetch(`${apiBase}/api/locations`);
    const locations = await locRes.json();
    const locationName = locations.find(l => l.location_id == fullSession.location_id)?.name || 'Unknown';

    // Get actual participant count from active session list
    const countRes = await fetch(`${apiBase}/api/sessions/active?location_id=${fullSession.location_id}`);
    const sessionList = await countRes.json();
    const match = sessionList.find(s => s.session_id == sessionId);
    const participant_count = match?.participant_count || 1;

    showSessionInfo({
        session_id: sessionId,
        start_time: fullSession.start_time,
        location: locationName,
        participant_count,
        user_join_time: activeSession.join_time,
        started_by_current_user: fullSession.started_by == currentUser.participant_id
    });
    }

    async function joinSession(sessionId) {
    const joinTime = new Date().toISOString();

    try {
        await fetch(`${apiBase}/api/participant-sessions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            participant_id: currentUser.participant_id,
            session_id: sessionId,
            join_time: joinTime,
            leave_time: null
        })
        });

        const sessionRes = await fetch(`${apiBase}/api/sessions`);
        const allSessions = await sessionRes.json();
        const fullSession = allSessions.find(s => s.session_id == sessionId);

        const locRes = await fetch(`${apiBase}/api/locations`);
        const locations = await locRes.json();
        const locationName = locations.find(l => l.location_id == fullSession.location_id)?.name || 'Unknown';

        showSessionInfo({
        session_id: sessionId,
        start_time: fullSession.start_time,
        location: locationName,
        participant_count: 1,
        user_join_time: joinTime,
        started_by_current_user: fullSession.started_by == currentUser.participant_id
        });
    } catch (err) {
        console.error('Error joining session:', err);
        alert('Failed to join session');
    }
    }
    async function leaveSession() {
    const sessionId = document.getElementById('infoSessionId').textContent;
    if (!sessionId || !currentUser.participant_id) return;

    const leaveTime = new Date().toISOString();

    try {
        await fetch(`${apiBase}/api/participant-sessions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            participant_id: currentUser.participant_id,
            session_id: sessionId,
            leave_time: leaveTime
        })
        });

        alert("You have left the session.");
        document.getElementById('sessionInfoBlock').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        await loadActiveSessions();

    } catch (err) {
        console.error("Failed to leave session:", err);
        alert("Error while leaving session.");
    }
    }


    async function endSession() {
    const sessionId = document.getElementById('infoSessionId').textContent;
    if (!sessionId) return;

    const endTime = new Date().toISOString();

    try {
        const res = await fetch(`${apiBase}/api/sessions/${sessionId}/end`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ end_time: endTime })
        });

        if (res.ok) {
        alert("Session ended!");
        document.getElementById('sessionInfoBlock').style.display = 'none';
        document.querySelector('.container').style.display = 'block';
        await loadActiveSessions();
        } else {
        alert("Failed to end session.");
        }
    } catch (err) {
        console.error("Error ending session:", err);
        alert("Error while ending session.");
    }
    }

    // Add this helper function:
    async function loadParticipantsForCalculation() {
    const sessionId = document.getElementById('infoSessionId').textContent;
    const res = await fetch(`${apiBase}/api/sessions/${sessionId}/participants`);
    const data = await res.json();

    const container = document.getElementById('calcParticipants');
    container.innerHTML = '';

    data.forEach(p => {
        container.innerHTML += `
        <div style="margin-bottom: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px;">
            <strong>${p.name}</strong><br>
            Join: <input type="time" value="${new Date(p.join_time).toISOString().slice(11, 16)}" data-id="${p.participant_id}" class="joinTime"> 
            Leave: <input type="time" value="${p.leave_time ? new Date(p.leave_time).toISOString().slice(11, 16) : ''}" class="leaveTime">
        </div>
        `;
    });
    }


    async function calculateSessionCost() {
    const totalPaid = parseFloat(document.getElementById('calcPaid').value);
        if (isNaN(totalPaid) || totalPaid <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        let sessionId = document.getElementById('infoSessionId')?.textContent;

    // If no session ID from UI, try to find the unpaid session started by this user
    if (!sessionId) {
    try {
        const res = await fetch(`${apiBase}/api/sessions/unpaid-host/${currentUser.participant_id}`);
        if (res.ok) {
        const session = await res.json();
        sessionId = session.session_id;
        console.log("Using session_id:", sessionId);
        console.log("Unpaid session found:", session);

        } else {
        alert("No unpaid session found for you.");
        return;
        }
    } catch (err) {
        console.error("Error fetching unpaid session:", err);
        alert("Failed to find unpaid session.");
        return;
    }
    }

    const res = await fetch(`${apiBase}/api/sessions/${sessionId}/participants`);
    const participants = await res.json();
    console.log("Participants:", participants);




    if (!participants.length) {
        document.getElementById('calcResult').innerHTML = '<p>No participants found.</p>';
        return;
    }

    // Calculate total minutes per participant and total minutes overall
    const breakdown = [];
    let totalMinutes = 0;

    participants.forEach(p => {
        if (!p.join_time) return;

        const join = new Date(p.join_time);
        const now = new Date();
        const leave = p.leave_time ? new Date(p.leave_time) : now;


        const minutes = Math.max(0, Math.floor((leave - join) / 60000));
        totalMinutes += minutes;

        breakdown.push({
            name: p.name,
            minutes,
            joinTime: join.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            leaveTime: leave.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            leaveUsedNow: !p.leave_time
        });
    });



    if (totalMinutes === 0) {
        document.getElementById('calcResult').innerHTML = '<p>No valid time data found.</p>';
        return;
    }

    // Cost per minute
    const costPerMinute = totalPaid / totalMinutes;

    // Final cost per user
    let html = `<p><strong>Total Paid:</strong> $${totalPaid.toFixed(2)}<br><strong>Total Minutes:</strong> ${totalMinutes} min<br><strong>Rate:</strong> $${costPerMinute.toFixed(4)}/min</p>`;
    html += `<ul>`;
    breakdown.forEach(p => {
    const cost = p.minutes * costPerMinute;
    html += `<li><strong>${p.name}</strong>: ${p.joinTime} ‚Äì ${p.leaveTime} (${p.minutes} min) ‚Üí <strong>$${cost.toFixed(2)}</strong></li>`;
    });
    html += `</ul>`;


    document.getElementById('calcResult').innerHTML = html;
    }
    async function loadSessionAndParticipantsForCalc() {
    const detailBlock = document.getElementById('sessionDetails');
    const listBlock = document.getElementById('participantCostList');
    const sessionId = document.getElementById('infoSessionId')?.textContent;

    let session;
    try {
        if (sessionId) {
        const sessionRes = await fetch(`${apiBase}/api/sessions/${sessionId}`);
        session = (await sessionRes.json())[0];
        } else {
        const unpaidRes = await fetch(`${apiBase}/api/sessions/unpaid-host/${currentUser.participant_id}`);
        session = await unpaidRes.json();
        }
        if (!session) {
        detailBlock.innerHTML = 'No session found.';
        return;
        }
    } catch (err) {
        detailBlock.innerHTML = 'No unpaid session found.';
        console.error(err);
        return;
    }

    detailBlock.innerHTML = `
        <strong>Session #:</strong> ${session.session_id}<br>
        <strong>Location:</strong> ${session.location_name || 'N/A'}<br>
        <strong>Date:</strong> ${new Date(session.start_time).toLocaleDateString()}
    `;

    try {
        const res = await fetch(`${apiBase}/api/sessions/${session.session_id}/participants`);
        const participants = await res.json();

        if (!participants.length) {
        listBlock.innerHTML = 'No participants found.';
        return;
        }

        window._calcParticipants = participants.map(p => {
        return {
            id: p.participant_id, // üëà include this!
            name: p.name,
            joinTime: new Date(p.join_time),
            leaveTime: p.leave_time ? new Date(p.leave_time) : null,
            adjusted_cost: 0
        };
        });



        // Start a dynamic updater
        function updateLiveTimes() {
        const now = new Date();
        const listBlock = document.getElementById('participantCostList');

        listBlock.innerHTML = window._calcParticipants.map(p => {
            const isLive = !p.leaveTime;
            const effectiveLeave = isLive ? now : p.leaveTime;
            const mins = Math.max(0, Math.floor((effectiveLeave - p.joinTime) / 60000));

            const joinStr = p.joinTime.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: 'America/Los_Angeles'
            });

            const leaveStr = effectiveLeave.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: 'America/Los_Angeles'
            });

            p.minutes = mins;

            return `
            <div class="participant-row">
                <div class="name">${p.name}</div>
                <div class="time">${joinStr} ‚Äì ${leaveStr}${isLive ? ' <span style="color:green;">(now)</span>' : ''}</div>
                <div class="minutes">${mins} min</div>
            </div>
            `;
        }).join('');
        }




        // Update every second
        setInterval(() => {
        if (window._calcParticipants?.some(p => p.isLive)) {
            updateLiveTimes();
        }
        }, 1000);

        updateLiveTimes(); // Run immediately once


        listBlock.innerHTML = window._calcParticipants.map(p => {
        const joinStr = p.joinTime.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true,
            timeZone: 'America/Los_Angeles'
        });

        const leaveStr = p.leaveTime
            ? p.leaveTime.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Los_Angeles'
            })
            : 'Now';

        return `
            <div class="participant-row">
                <div class="name">${p.name}</div>
                <div class="time">${joinStr} ‚Äì ${leaveStr}</div>
                <div class="minutes">${p.minutes} min</div>
            </div>
        `;
        }).join('');




    } catch (err) {
        listBlock.innerHTML = 'Error fetching participants.';
        console.error(err);
    }
    }

    function calculateFinalCosts() {
    const totalPaid = parseFloat(document.getElementById('calcPaid').value);
    const resultBlock = document.getElementById('calcResult');

    if (isNaN(totalPaid) || totalPaid <= 0) {
        resultBlock.innerHTML = '<p>Please enter a valid total amount paid.</p>';
        return;
    }

    const participants = window._calcParticipants || [];
    const totalMinutes = participants.reduce((sum, p) => sum + p.minutes, 0);

    if (totalMinutes === 0) {
        resultBlock.innerHTML = '<p>No valid time data found.</p>';
        return;
    }

    const costPerMinute = totalPaid / totalMinutes;
    let html = '';
    let breakdownText = `Cost Breakdown:\n`;

    html += `<div style="background: #f9f9ff; padding: 10px; border-radius: 6px; margin-top: 10px;">`;

    participants.forEach(p => {
        const owed = costPerMinute * p.minutes;
        p.adjusted_cost = parseFloat(owed.toFixed(2));
        html += `
        <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
            <strong>${p.name}</strong>: ${p.minutes} min ‚Üí <span style="color: #28a745;">$${owed.toFixed(2)}</span>
        </div>
        `;
        breakdownText += `${p.name}: ${p.minutes} min ‚Üí $${owed.toFixed(2)}\n`;
    });

    html += `</div>`;
    resultBlock.innerHTML = html;

    // Copy to clipboard
    navigator.clipboard.writeText(breakdownText.trim()).then(() => {
        alert("Cost breakdown copied to clipboard.");
    }).catch(err => {
        console.error("Copy failed:", err);
        alert("Failed to copy to clipboard.");
    });
    }


    async function confirmCostData() {
    calculateFinalCosts();

    const totalPaid = parseFloat(document.getElementById('calcPaid').value);
    if (isNaN(totalPaid) || totalPaid <= 0) {
        alert("Please enter a valid total amount.");
        return;
    }

    let sessionId = document.getElementById('infoSessionId')?.textContent;
    if (!sessionId) {
        const res = await fetch(`${apiBase}/api/sessions/unpaid-host/${currentUser.participant_id}`);
        if (!res.ok) {
        alert("Session not found.");
        return;
        }
        const session = await res.json();
        sessionId = session.session_id;
    }

    // Check if session has ended
    const sessionRes = await fetch(`${apiBase}/api/sessions/${sessionId}`);
    const sessionData = (await sessionRes.json())[0];
    if (!sessionData.end_time) {
        alert("Please end the session before confirming payment.");
        return;
    }

    // Confirm posting data
    const participants = window._calcParticipants || [];
    if (!participants.length) {
        alert("No participant cost data available.");
        return;
    }

    try {
        // 1. Update session total
        await fetch(`${apiBase}/api/sessions/${sessionId}/paid`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ total_actual_paid: totalPaid })
        });

        // 2. Update participant costs
        const costUpdates = participants.map(p => ({
        participant_id: p.id, // make sure you're including `id` in _calcParticipants
        adjusted_cost: p.adjusted_cost
        }));

        await fetch(`${apiBase}/api/sessions/${sessionId}/adjust-costs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ costs: costUpdates })
        });

        alert("Cost confirmed and saved!");
    } catch (err) {
        console.error("Error confirming data:", err);
        alert("Failed to confirm cost data.");
    }
    }

  </script>
</body>
</html>
